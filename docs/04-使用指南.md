# 使用指南

> 版本：1.0.0 | 最后更新：2026-02-28

---

## 1. 前置条件

### 1.1 环境要求

| 组件     | 最低版本 | 推荐版本                | 说明                      |
| -------- | -------- | ----------------------- | ------------------------- |
| JDK      | 21       | 21 LTS (Temurin)        | 框架使用 Java 21 语法特性 |
| Maven    | 3.9+     | 3.9.9（Wrapper）        | 项目自带 Maven Wrapper    |
| Git      | 2.30+    | 最新版                  | 代码版本管理              |
| 操作系统 | -        | Windows / macOS / Linux | 跨平台支持                |

### 1.2 JDK 安装

**Windows（推荐使用 winget）：**

```bash
winget install EclipseAdoptium.Temurin.21.JDK
```

**macOS（使用 Homebrew）：**

```bash
brew install --cask temurin@21
```

**Linux（Ubuntu/Debian）：**

```bash
sudo apt install temurin-21-jdk
```

### 1.3 环境变量配置

**Windows PowerShell：**

```powershell
$env:JAVA_HOME = "C:\Program Files\Eclipse Adoptium\jdk-21.0.10.7-hotspot"
$env:PATH = "$env:JAVA_HOME\bin;$env:PATH"
```

**macOS / Linux（bash/zsh）：**

```bash
export JAVA_HOME=/usr/lib/jvm/temurin-21-jdk
export PATH=$JAVA_HOME/bin:$PATH
```

验证安装：

```bash
java -version
# 输出应包含：openjdk version "21.x.x"
```

### 1.4 获取项目代码

```bash
git clone <项目仓库地址>
cd java-cucumber-framework
```

> **注意**：项目已自带 Maven Wrapper（`mvnw` / `mvnw.cmd`），无需单独安装 Maven。

---

## 2. 快速开始

### 2.1 运行所有测试

**Windows：**

```powershell
.\mvnw.cmd clean test
```

**macOS / Linux：**

```bash
./mvnw clean test
```

### 2.2 运行特定标签的测试

```bash
# 只运行 @smoke 标签的测试
.\mvnw.cmd test "-Dcucumber.filter.tags=@smoke"

# 只运行 REST 冒烟测试
.\mvnw.cmd test "-Dcucumber.filter.tags=@rest and @smoke"

# 排除 @ignore 标签
.\mvnw.cmd test "-Dcucumber.filter.tags=not @ignore"

# 组合标签（REST 或 SOAP）
.\mvnw.cmd test "-Dcucumber.filter.tags=@rest or @soap"
```

### 2.3 查看测试报告

测试完成后，报告文件生成于：

```
target/cucumber-reports/
├── cucumber.html    ← 直接在浏览器中打开
└── cucumber.json    ← 用于 CI/CD 集成
```

打开 HTML 报告：

**Windows：**

```powershell
Start-Process "target\cucumber-reports\cucumber.html"
```

**macOS：**

```bash
open target/cucumber-reports/cucumber.html
```

---

## 3. 环境切换

框架支持多环境配置，通过 Maven Profile 或系统属性切换。

### 3.1 配置文件结构

```
src/main/resources/
├── application.yml           # 基础配置（默认）
├── application-dev.yml       # 开发环境覆盖
└── application-staging.yml   # 预发布环境覆盖
```

### 3.2 配置文件示例

**application.yml（基础配置）：**

```yaml
rest:
  base-url: https://jsonplaceholder.typicode.com
  connect-timeout: 5000
  read-timeout: 10000
  log-requests: true
  log-responses: true

proxy:
  enabled: false
```

**application-dev.yml（开发环境）：**

```yaml
rest:
  base-url: https://dev-api.example.com
  connect-timeout: 10000
```

**application-staging.yml（预发布环境）：**

```yaml
rest:
  base-url: https://staging-api.example.com
```

### 3.3 切换方式

**方式一：Maven Profile**

```bash
# 使用开发环境
.\mvnw.cmd test -Pdev

# 使用预发布环境
.\mvnw.cmd test -Pstaging

# 使用生产环境
.\mvnw.cmd test -Pprod
```

**方式二：系统属性**

```bash
.\mvnw.cmd test "-Dtest.env=dev"
.\mvnw.cmd test "-Dtest.env=staging"
```

**方式三：环境变量**

```bash
# Windows PowerShell
$env:TEST_ENV = "dev"
.\mvnw.cmd test

# Linux / macOS
TEST_ENV=dev ./mvnw test
```

### 3.4 配置优先级

```
系统属性 (-D) > 环境变量 > 环境配置文件 > 基础配置文件
```

即：通过 `-D` 传入的属性优先级最高，可覆盖任何配置。

```bash
# 临时覆盖 base-url（不管环境配置文件怎么写）
.\mvnw.cmd test "-Drest.base-url=https://custom-api.example.com"
```

---

## 4. Maven Profile 详解

### 4.1 协议 Profile

| Profile | 激活方式  | 说明                   |
| ------- | --------- | ---------------------- |
| `rest`  | `-Prest`  | REST 测试依赖          |
| `soap`  | `-Psoap`  | SOAP 测试依赖（未来）  |
| `mqtt`  | `-Pmqtt`  | MQTT 测试依赖（未来）  |
| `kafka` | `-Pkafka` | Kafka 测试依赖（未来） |
| `all`   | `-Pall`   | 加载所有协议依赖       |

### 4.2 环境 Profile

| Profile   | 激活方式    | 说明         |
| --------- | ----------- | ------------ |
| `dev`     | `-Pdev`     | 开发环境     |
| `staging` | `-Pstaging` | 预发布环境   |
| `prod`    | `-Pprod`    | 生产验证环境 |

### 4.3 组合使用

```bash
# REST + 预发布环境
.\mvnw.cmd test -Prest -Pstaging

# 所有协议 + 开发环境
.\mvnw.cmd test -Pall -Pdev
```

---

## 5. 常用命令速查

### 5.1 测试执行

| 命令                                                   | 说明                       |
| ------------------------------------------------------ | -------------------------- |
| `.\mvnw.cmd clean test`                                | 清空输出目录并运行所有测试 |
| `.\mvnw.cmd test`                                      | 运行所有测试               |
| `.\mvnw.cmd test -Pdev`                                | 使用 dev 环境运行          |
| `.\mvnw.cmd test "-Dcucumber.filter.tags=@smoke"`      | 运行冒烟测试               |
| `.\mvnw.cmd test "-Dcucumber.filter.tags=not @ignore"` | 排除标记忽略的测试         |

### 5.2 构建命令

| 命令                                             | 说明             |
| ------------------------------------------------ | ---------------- |
| `.\mvnw.cmd clean compile`                       | 编译项目         |
| `.\mvnw.cmd clean package -DskipTests`           | 打包（跳过测试） |
| `.\mvnw.cmd dependency:tree`                     | 查看依赖树       |
| `.\mvnw.cmd dependency:resolve`                  | 下载所有依赖     |
| `.\mvnw.cmd versions:display-dependency-updates` | 检查依赖更新     |

### 5.3 调试命令

| 命令                                          | 说明                |
| --------------------------------------------- | ------------------- |
| `.\mvnw.cmd test -X`                          | 开启 Maven 调试输出 |
| `.\mvnw.cmd test -e`                          | 显示完整错误堆栈    |
| `.\mvnw.cmd test "-Drest.log-requests=true"`  | 开启请求日志        |
| `.\mvnw.cmd test "-Drest.log-responses=true"` | 开启响应日志        |

---

## 6. 日志配置

### 6.1 日志级别控制

日志配置文件：`src/test/resources/logback-test.xml`

| 级别    | 说明     | 场景             |
| ------- | -------- | ---------------- |
| `TRACE` | 最详细   | 深度调试         |
| `DEBUG` | 调试信息 | 开发调试         |
| `INFO`  | 一般信息 | 正常执行（默认） |
| `WARN`  | 警告     | 潜在问题         |
| `ERROR` | 错误     | 执行失败         |

### 6.2 运行时调整日志级别

```bash
.\mvnw.cmd test "-Dlogging.level.com.framework=DEBUG"
```

### 6.3 日志输出位置

```
控制台 ← 实时查看
target/logs/test-framework.log ← 完整记录
```

---

## 7. IDE 集成

### 7.1 IntelliJ IDEA

1. **导入项目**：`File → Open → 选择项目根目录`
2. **安装插件**：
   - Cucumber for Java（必装）
   - Lombok（必装）
   - Gherkin（语法高亮）
3. **设置 JDK**：`File → Project Structure → Project SDK → 21`
4. **运行单个 Feature**：右键 `.feature` 文件 → `Run`
5. **运行指定 Scenario**：右键 Scenario 名称行 → `Run`

### 7.2 VS Code

1. **安装扩展**：
   - Extension Pack for Java
   - Cucumber (Gherkin) Full Support
   - Lombok Annotations Support
2. **运行测试**：在终端中执行 `.\mvnw.cmd test` 命令

---

## 8. 常见问题

### Q1：编译报错 `invalid source release: 21`

**原因**：系统 JDK 版本不是 21。

**解决**：确保 `JAVA_HOME` 指向 JDK 21：

```powershell
$env:JAVA_HOME = "C:\Program Files\Eclipse Adoptium\jdk-21.0.10.7-hotspot"
$env:PATH = "$env:JAVA_HOME\bin;$env:PATH"
java -version
```

### Q2：测试无法发现 / 0 tests run

**原因**：Feature 文件路径或 Glue 包路径配置错误。

**检查**：

- Feature 文件位于 `src/test/resources/features/` 目录下
- `junit-platform.properties` 中 `cucumber.glue` 配置正确
- Runner 类的 `@SelectClasspathResource("features")` 注解正确

### Q3：网络超时 / Connection refused

**原因**：目标 API 不可达或在代理环境中。

**解决**：

```bash
# 检查网络连通性
curl https://jsonplaceholder.typicode.com/users/1

# 配置代理
.\mvnw.cmd test "-Dhttp.proxyHost=proxy.example.com" "-Dhttp.proxyPort=8080"
```

### Q4：响应时间断言间歇性失败

**原因**：网络波动导致响应时间不稳定。

**解决**：适当调大阈值，或在 CI 环境中使用更宽松的阈值：

```gherkin
Then the response time should be less than 10000 ms
```

### Q5：中文乱码

**原因**：系统编码与 UTF-8 不一致。

**解决**：

```bash
.\mvnw.cmd test "-Dfile.encoding=UTF-8"
```
