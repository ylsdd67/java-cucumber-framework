# 测试指南

> 版本：1.0.0 | 最后更新：2026-02-28

---

## 1. 测试体系概述

本框架采用 **BDD（行为驱动开发）** 方法论，使用 Gherkin 语法编写测试用例，让业务人员、测试人员和开发人员使用统一的语言描述需求和验证行为。

### 1.1 测试金字塔定位

```
        ┌─────────────────┐
        │   E2E 测试       │  ← 本框架所在层级
        │  (API / 协议)    │
        ├─────────────────┤
        │   集成测试        │
        ├─────────────────┤
        │   单元测试        │
        └─────────────────┘
```

### 1.2 测试文件组织

```
src/test/resources/features/
├── rest/                        # REST API 测试
│   ├── sample_api.feature       # 示例测试（CRUD）
│   ├── user_api.feature         # 用户模块（按业务划分）
│   └── order_api.feature        # 订单模块
├── soap/                        # SOAP 测试（未来）
├── mqtt/                        # MQTT 测试（未来）
└── kafka/                       # Kafka 测试（未来）
```

---

## 2. 编写测试用例

### 2.1 Feature 文件基本结构

```gherkin
@rest                                    # ← 标签：用于筛选和分类
Feature: 用户管理 API 测试                  # ← 功能名称
  作为一个 QA 工程师                        # ← 角色
  我需要测试用户管理 API                    # ← 需求
  以确保 API 行为符合预期                   # ← 目的

  Background:                             # ← 前置条件（所有场景共享）
    Given the REST API base URL is "https://api.example.com"

  Scenario: 获取单个用户                    # ← 测试场景
    When I send a GET request to "/users/1"
    Then the response status code should be 200
    And the JSON path "$.name" should not be empty
```

### 2.2 标签（Tag）系统

| 标签          | 用途               | 示例                   |
| ------------- | ------------------ | ---------------------- |
| `@rest`       | 标记 REST API 测试 | 所有 REST 场景必须添加 |
| `@soap`       | 标记 SOAP 测试     | SOAP 场景（未来）      |
| `@mqtt`       | 标记 MQTT 测试     | MQTT 场景（未来）      |
| `@kafka`      | 标记 Kafka 测试    | Kafka 场景（未来）     |
| `@smoke`      | 冒烟测试           | 核心流程验证           |
| `@regression` | 回归测试           | 完整回归               |
| `@ignore`     | 跳过执行           | 临时跳过               |
| `@wip`        | 开发中             | 未完成的用例           |

**标签组合执行：**

```bash
# 执行 REST 中的冒烟测试
.\mvnw.cmd test "-Dcucumber.filter.tags=@rest and @smoke"

# 执行所有非忽略的测试
.\mvnw.cmd test "-Dcucumber.filter.tags=not @ignore"

# 执行 REST 或 SOAP 测试
.\mvnw.cmd test "-Dcucumber.filter.tags=@rest or @soap"
```

---

## 3. 可用步骤定义参考

### 3.1 请求构建步骤（Given）

#### 设置 Base URL

```gherkin
Given the REST API base URL is "https://api.example.com"
```

#### 设置请求头

```gherkin
# 单个 Header
Given I set header "Content-Type" to "application/json"
Given I set header "X-Request-Id" to "test-12345"

# 多个 Header（DataTable 格式）
Given I set the following headers:
  | Accept       | application/json |
  | X-Request-Id | test-12345       |
  | X-Tenant-Id  | tenant-001       |
```

#### 设置参数

```gherkin
# Query 参数（URL 查询参数）
Given I set query parameter "page" to "1"
Given I set query parameter "size" to "20"

# Path 参数（URL 路径参数）
Given I set path parameter "userId" to "123"
```

#### 设置请求体

```gherkin
# 内联 JSON Body
Given I set the request body to:
  """
  {
    "name": "张三",
    "email": "zhangsan@example.com",
    "age": 30
  }
  """

# 从文件加载 Body
Given I set the request body from file "testdata/create_user.json"
```

#### 设置认证

```gherkin
# Bearer Token 认证
Given I set bearer token "eyJhbGciOiJIUzI1NiIs..."

# Basic Auth 认证
Given I set basic auth with username "admin" and password "password123"
```

#### 设置 Content Type

```gherkin
Given I set request content type to "application/xml"
```

#### 存储变量

```gherkin
Given I store "test-value" as "myVariable"
```

### 3.2 请求执行步骤（When）

```gherkin
# 不带 Body 的请求
When I send a GET request to "/users"
When I send a DELETE request to "/users/1"

# 带 Body 的请求
When I send a POST request to "/users" with body:
  """
  {
    "name": "李四",
    "email": "lisi@example.com"
  }
  """

When I send a PUT request to "/users/1" with body:
  """
  {
    "name": "李四（更新）",
    "email": "lisi_new@example.com"
  }
  """
```

### 3.3 响应断言步骤（Then）

#### 状态码断言

```gherkin
# 精确匹配
Then the response status code should be 200
Then the response status code should be 201
Then the response status code should be 404

# 多值匹配
Then the response status code should be one of "200,201"
```

#### 响应体断言

```gherkin
# 包含/不包含字符串
Then the response body should contain "success"
Then the response body should not contain "error"

# JSON 格式验证
Then the response body should be valid JSON
```

#### JSON Path 断言

```gherkin
# 字符串相等
Then the JSON path "$.name" should equal "张三"

# 数字相等
Then the JSON path "$.id" should equal 1

# 非空检查
Then the JSON path "$.data" should not be empty

# 数组大小
Then the JSON path "$.items" should have 10 items

# 包含子串
Then the JSON path "$.message" should contain "成功"
```

**JSON Path 语法速查：**

| 表达式             | 含义                 |
| ------------------ | -------------------- |
| `$`                | 根节点               |
| `$.name`           | 根节点下的 name 字段 |
| `$.data.items`     | 嵌套对象字段         |
| `$.items[0]`       | 数组第一个元素       |
| `$.items[*].name`  | 所有元素的 name      |
| `$.items.length()` | 数组长度             |
| `$..name`          | 递归查找所有 name    |

#### 响应头断言

```gherkin
# 精确匹配
Then the response header "Content-Type" should be "application/json; charset=utf-8"

# 包含匹配
Then the response header "Content-Type" should contain "application/json"
```

#### 性能断言

```gherkin
Then the response time should be less than 3000 ms
```

#### Content-Type 断言

```gherkin
Then the response content type should be "application/json"
```

#### 数据提取与存储

```gherkin
# 从 JSON Path 提取并存储
Then I store the JSON path "$.id" as "newUserId"
Then I store the JSON path "$.token" as "authToken"

# 从响应头提取并存储
Then I store the response header "Location" as "resourceUrl"
```

#### 调试步骤

```gherkin
Then I print the response body
```

---

## 4. 测试用例示例

### 4.1 完整 CRUD 测试

```gherkin
@rest @crud
Feature: 用户 CRUD API 测试

  Background:
    Given the REST API base URL is "https://jsonplaceholder.typicode.com"

  @smoke
  Scenario: 创建用户
    Given I set header "Content-Type" to "application/json"
    When I send a POST request to "/users" with body:
      """
      {
        "name": "张三",
        "email": "zhangsan@example.com",
        "phone": "13800138000"
      }
      """
    Then the response status code should be 201
    And the response body should be valid JSON
    And the JSON path "$.name" should equal "张三"
    And I store the JSON path "$.id" as "newUserId"

  @smoke
  Scenario: 查询用户
    When I send a GET request to "/users/1"
    Then the response status code should be 200
    And the JSON path "$.id" should equal 1
    And the JSON path "$.name" should not be empty
    And the response time should be less than 10000 ms

  Scenario: 查询用户列表
    When I send a GET request to "/users"
    Then the response status code should be 200
    And the JSON path "$" should not be empty

  Scenario: 带分页参数查询
    Given I set query parameter "userId" to "1"
    When I send a GET request to "/posts"
    Then the response status code should be 200
    And the JSON path "$[0].userId" should equal 1

  Scenario: 更新用户
    When I send a PUT request to "/users/1" with body:
      """
      {
        "id": 1,
        "name": "张三（更新）",
        "email": "zhangsan_new@example.com"
      }
      """
    Then the response status code should be 200
    And the JSON path "$.name" should equal "张三（更新）"

  Scenario: 删除用户
    When I send a DELETE request to "/users/1"
    Then the response status code should be 200
```

### 4.2 认证测试

```gherkin
@rest @auth
Feature: API 认证测试

  Background:
    Given the REST API base URL is "https://api.example.com"

  Scenario: Bearer Token 认证
    Given I set bearer token "eyJhbGciOiJIUzI1NiIsInR5..."
    When I send a GET request to "/api/protected/resource"
    Then the response status code should be 200

  Scenario: Basic Auth 认证
    Given I set basic auth with username "admin" and password "secret"
    When I send a GET request to "/api/admin/dashboard"
    Then the response status code should be 200

  Scenario: 无认证访问受保护资源
    When I send a GET request to "/api/protected/resource"
    Then the response status code should be one of "401,403"
```

### 4.3 链式数据传递测试

```gherkin
@rest @chain
Feature: 链式 API 测试 — 创建后查询

  Background:
    Given the REST API base URL is "https://jsonplaceholder.typicode.com"

  Scenario: 创建帖子并提取 ID
    When I send a POST request to "/posts" with body:
      """
      {
        "title": "测试帖子",
        "body": "这是帖子内容",
        "userId": 1
      }
      """
    Then the response status code should be 201
    And I store the JSON path "$.id" as "postId"
    And I print the response body
```

---

## 5. 数据驱动测试

### 5.1 Scenario Outline（场景大纲）

```gherkin
@rest @data-driven
Feature: 数据驱动测试

  Scenario Outline: 查询不同用户
    When I send a GET request to "/users/<userId>"
    Then the response status code should be 200
    And the JSON path "$.name" should equal "<expectedName>"

    Examples:
      | userId | expectedName     |
      | 1      | Leanne Graham    |
      | 2      | Ervin Howell     |
      | 3      | Clementine Bauch |
```

### 5.2 DataTable 驱动

```gherkin
@rest
Feature: 批量 Header 设置
  Scenario: 发送带多个自定义头的请求
    Given I set the following headers:
      | Accept          | application/json  |
      | Accept-Language | zh-CN             |
      | X-Request-Id    | req-001           |
      | X-Tenant-Id     | tenant-001        |
    When I send a GET request to "/users/1"
    Then the response status code should be 200
```

---

## 6. 测试报告

### 6.1 报告输出位置

| 格式 | 路径                                    | 用途                   |
| ---- | --------------------------------------- | ---------------------- |
| HTML | `target/cucumber-reports/cucumber.html` | 直接浏览器打开查看     |
| JSON | `target/cucumber-reports/cucumber.json` | CI/CD 集成、自定义报告 |

### 6.2 HTML 报告内容

- ✅ 通过/❌ 失败/⏭ 跳过 场景汇总
- 每个场景的详细步骤执行结果
- 失败场景附带最后一次响应体（由 `@After` 钩子自动附加）
- 执行时间统计

### 6.3 日志输出

- **控制台日志**：实时显示场景执行过程
- **文件日志**：`target/logs/test-framework.log`，保留完整调试信息

**日志示例：**

```
10:14:25.123 [main] INFO  c.f.hooks.Hooks - ========== SCENARIO START: 获取单个用户 ==========
10:14:25.123 [main] INFO  c.f.hooks.Hooks - Tags: [@rest, @smoke]
10:14:25.234 [main] INFO  c.f.protocols.rest.RestClient - Executing REST request: ProtocolRequest{method='GET', endpoint='/users/1'}
10:14:25.890 [main] INFO  c.f.protocols.rest.RestClient - REST response: status=200, time=656ms
10:14:25.891 [main] INFO  c.f.hooks.Hooks - ========== SCENARIO END: 获取单个用户 — PASSED ==========
```

---

## 7. 测试命名与组织规范

### 7.1 Feature 文件命名

```
{业务模块}_{功能描述}.feature

示例：
user_crud.feature        # 用户 CRUD
order_payment.feature    # 订单支付
auth_login.feature       # 认证登录
```

### 7.2 Scenario 命名规范

```
动词 + 对象 + 条件（可选）

示例：
✅ 创建用户
✅ 查询订单 - 按ID查询
✅ 删除帖子 - 帖子不存在时返回404
❌ test1
❌ 测试接口
```

### 7.3 标签使用规范

```gherkin
@rest @smoke                 # Feature 级别：协议 + 优先级
Feature: 用户管理 API

  @positive                   # Scenario 级别：测试类型
  Scenario: 正常创建用户
    ...

  @negative                   # Scenario 级别：测试类型
  Scenario: 参数缺失时创建用户失败
    ...
```
