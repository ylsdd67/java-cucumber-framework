# 构建部署文档

> 版本：1.0.0 | 最后更新：2026-02-28

---

## 1. 构建环境要求

### 1.1 最低要求

| 组件  | 版本                 | 说明                                                 |
| ----- | -------------------- | ---------------------------------------------------- |
| JDK   | 21 LTS               | 框架使用 Java 21 语法特性（switch 表达式、文本块等） |
| Maven | 3.9+                 | 项目已内置 Maven Wrapper，无需全局安装               |
| 网络  | 可访问 Maven Central | 首次构建需下载依赖                                   |
| 磁盘  | ≥ 500MB              | Maven 本地仓库 + 项目构建产物                        |

### 1.2 推荐 JDK 发行版

| 发行版             | 下载地址                         | 推荐度      |
| ------------------ | -------------------------------- | ----------- |
| Eclipse Temurin 21 | https://adoptium.net/            | ⭐⭐⭐ 推荐 |
| Oracle JDK 21      | https://www.oracle.com/java/     | ⭐⭐        |
| Amazon Corretto 21 | https://aws.amazon.com/corretto/ | ⭐⭐        |
| Azul Zulu 21       | https://www.azul.com/downloads/  | ⭐⭐        |

---

## 2. 环境搭建

### 2.1 Windows

#### 安装 JDK 21

**方式一：winget（推荐）**

```powershell
winget install EclipseAdoptium.Temurin.21.JDK
```

**方式二：手动安装**

1. 访问 https://adoptium.net/ 下载 Windows MSI 安装包
2. 双击安装，选择 "Set JAVA_HOME variable"
3. 安装完成后验证

#### 配置环境变量

```powershell
# 临时设置（当前会话生效）
$env:JAVA_HOME = "C:\Program Files\Eclipse Adoptium\jdk-21.0.10.7-hotspot"
$env:PATH = "$env:JAVA_HOME\bin;$env:PATH"

# 永久设置（需要管理员权限）
[Environment]::SetEnvironmentVariable("JAVA_HOME", "C:\Program Files\Eclipse Adoptium\jdk-21.0.10.7-hotspot", "Machine")
```

#### 验证

```powershell
java -version
# 输出：openjdk version "21.0.x" ...

.\mvnw.cmd -version
# 输出：Apache Maven 3.9.9
```

### 2.2 macOS

```bash
# 安装 JDK
brew install --cask temurin@21

# 配置环境变量（添加到 ~/.zshrc 或 ~/.bash_profile）
export JAVA_HOME=$(/usr/libexec/java_home -v 21)
export PATH=$JAVA_HOME/bin:$PATH

# 验证
java -version
./mvnw -version
```

### 2.3 Linux (Ubuntu/Debian)

```bash
# 安装 JDK
sudo apt update
sudo apt install temurin-21-jdk

# 或使用 SDKMAN（推荐）
curl -s "https://get.sdkman.io" | bash
sdk install java 21.0.2-tem

# 配置环境变量
export JAVA_HOME=/usr/lib/jvm/temurin-21-jdk
export PATH=$JAVA_HOME/bin:$PATH

# 验证
java -version
./mvnw -version
```

---

## 3. Maven Wrapper

### 3.1 说明

项目使用 Maven Wrapper，无需在系统上全局安装 Maven。Wrapper 文件结构：

```
项目根目录/
├── mvnw             # Linux/macOS 脚本
├── mvnw.cmd         # Windows 脚本
└── .mvn/
    └── wrapper/
        ├── maven-wrapper.jar           # Wrapper 引导 JAR
        └── maven-wrapper.properties    # Maven 版本配置
```

### 3.2 使用方式

| 平台                 | 命令                 |
| -------------------- | -------------------- |
| Windows (PowerShell) | `.\mvnw.cmd <goals>` |
| Windows (CMD)        | `mvnw.cmd <goals>`   |
| macOS / Linux        | `./mvnw <goals>`     |

### 3.3 首次使用

首次运行 `mvnw` 时会自动下载对应版本的 Maven（约 10MB），存储在 `~/.m2/wrapper/dists/` 目录下。后续运行无需再次下载。

### 3.4 升级 Maven 版本

编辑 `.mvn/wrapper/maven-wrapper.properties`：

```properties
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.9/apache-maven-3.9.9-bin.zip
```

---

## 4. 构建命令

### 4.1 基础构建

```bash
# 清理 + 编译
.\mvnw.cmd clean compile

# 清理 + 测试
.\mvnw.cmd clean test

# 清理 + 打包（包含测试）
.\mvnw.cmd clean package

# 清理 + 打包（跳过测试）
.\mvnw.cmd clean package -DskipTests

# 清理 + 安装到本地仓库
.\mvnw.cmd clean install
```

### 4.2 环境指定

```bash
# 开发环境
.\mvnw.cmd clean test -Pdev

# 预发布环境
.\mvnw.cmd clean test -Pstaging

# 生产验证环境
.\mvnw.cmd clean test -Pprod
```

### 4.3 协议指定

```bash
# 仅 REST
.\mvnw.cmd clean test -Prest

# 未来：SOAP
.\mvnw.cmd clean test -Psoap

# 所有协议
.\mvnw.cmd clean test -Pall
```

### 4.4 标签过滤

```bash
# 冒烟测试
.\mvnw.cmd test "-Dcucumber.filter.tags=@smoke"

# REST 回归测试
.\mvnw.cmd test "-Dcucumber.filter.tags=@rest and @regression"

# 排除忽略的测试
.\mvnw.cmd test "-Dcucumber.filter.tags=not @ignore"
```

### 4.5 组合命令

```bash
# 开发环境 + REST + 冒烟测试
.\mvnw.cmd clean test -Pdev -Prest "-Dcucumber.filter.tags=@smoke"

# 预发布环境 + 全量测试 + UTF-8 编码
.\mvnw.cmd clean test -Pstaging "-Dfile.encoding=UTF-8"
```

---

## 5. 构建产物

### 5.1 目录结构

```
target/
├── classes/                    # 编译后的主代码
├── test-classes/               # 编译后的测试代码
├── cucumber-reports/
│   ├── cucumber.html           # HTML 测试报告
│   └── cucumber.json           # JSON 测试报告
├── logs/
│   └── test-framework.log      # 运行日志
├── surefire-reports/           # Surefire 生成的标准报告
│   ├── TEST-*.xml              # JUnit XML 报告
│   └── *.txt                   # 文本报告
└── maven-status/               # Maven 编译状态
```

### 5.2 关键产物

| 文件                 | 用途           | 使用方式              |
| -------------------- | -------------- | --------------------- |
| `cucumber.html`      | 可视化测试报告 | 浏览器直接打开        |
| `cucumber.json`      | 机器可读报告   | CI/CD 插件解析        |
| `TEST-*.xml`         | JUnit XML 报告 | Jenkins / GitLab 集成 |
| `test-framework.log` | 详细运行日志   | 故障排查              |

---

## 6. CI/CD 集成

### 6.1 GitHub Actions

创建 `.github/workflows/api-tests.yml`：

```yaml
name: API Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 8 * * 1-5" # 工作日每天早上 8 点

jobs:
  api-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Run API Tests
        run: ./mvnw clean test -P${{ matrix.environment }}
        env:
          TEST_ENV: ${{ matrix.environment }}

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.environment }}
          path: |
            target/cucumber-reports/
            target/surefire-reports/
            target/logs/

      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: "API Test Results (${{ matrix.environment }})"
          path: "target/surefire-reports/TEST-*.xml"
          reporter: java-junit
```

### 6.2 GitLab CI

创建 `.gitlab-ci.yml`：

```yaml
stages:
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  key: maven-cache
  paths:
    - .m2/repository

api-tests:
  image: eclipse-temurin:21-jdk
  stage: test
  script:
    - chmod +x mvnw
    - ./mvnw clean test -P${ENV:-dev}
  artifacts:
    when: always
    paths:
      - target/cucumber-reports/
      - target/surefire-reports/
      - target/logs/
    reports:
      junit: target/surefire-reports/TEST-*.xml
    expire_in: 30 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

api-tests-staging:
  extends: api-tests
  variables:
    ENV: staging
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
```

### 6.3 Jenkins Pipeline

创建 `Jenkinsfile`：

```groovy
pipeline {
    agent any

    tools {
        jdk 'JDK-21'
    }

    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'staging', 'prod'], description: '目标测试环境')
        string(name: 'TAGS', defaultValue: '@smoke', description: 'Cucumber 标签过滤')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    if (isUnix()) {
                        sh "./mvnw clean test -P${params.ENVIRONMENT} -Dcucumber.filter.tags='${params.TAGS}'"
                    } else {
                        bat ".\\mvnw.cmd clean test -P${params.ENVIRONMENT} \"-Dcucumber.filter.tags=${params.TAGS}\""
                    }
                }
            }
        }
    }

    post {
        always {
            // JUnit 报告
            junit 'target/surefire-reports/TEST-*.xml'

            // 归档产物
            archiveArtifacts artifacts: 'target/cucumber-reports/**, target/logs/**', allowEmptyArchive: true

            // 清理
            cleanWs()
        }
        failure {
            // 发送失败通知（根据需要配置）
            echo 'Tests failed! Check the report for details.'
        }
    }
}
```

---

## 7. Docker 支持

### 7.1 Dockerfile

```dockerfile
FROM eclipse-temurin:21-jdk AS builder

WORKDIR /app
COPY . .
RUN chmod +x mvnw && ./mvnw dependency:resolve

FROM eclipse-temurin:21-jdk

WORKDIR /app
COPY --from=builder /app .
COPY --from=builder /root/.m2 /root/.m2

ENTRYPOINT ["./mvnw", "clean", "test"]
CMD ["-Pdev"]
```

### 7.2 Docker Compose

```yaml
version: "3.8"

services:
  api-tests:
    build: .
    environment:
      - TEST_ENV=${TEST_ENV:-dev}
      - JAVA_OPTS=-Xmx512m
    volumes:
      - ./target:/app/target # 挂载报告目录
    command: ["./mvnw", "clean", "test", "-P${TEST_ENV:-dev}"]
```

### 7.3 使用 Docker 运行

```bash
# 构建镜像
docker build -t api-test-framework .

# 运行测试（默认 dev 环境）
docker run --rm -v $(pwd)/target:/app/target api-test-framework

# 运行测试（指定环境和标签）
docker run --rm \
  -v $(pwd)/target:/app/target \
  -e TEST_ENV=staging \
  api-test-framework \
  ./mvnw clean test -Pstaging "-Dcucumber.filter.tags=@smoke"
```

---

## 8. 代理与私有仓库配置

### 8.1 HTTP 代理

创建或编辑 `~/.m2/settings.xml`：

```xml
<settings>
  <proxies>
    <proxy>
      <id>http-proxy</id>
      <active>true</active>
      <protocol>http</protocol>
      <host>proxy.example.com</host>
      <port>8080</port>
      <username>proxyuser</username>
      <password>proxypass</password>
      <nonProxyHosts>localhost|127.0.0.1</nonProxyHosts>
    </proxy>
    <proxy>
      <id>https-proxy</id>
      <active>true</active>
      <protocol>https</protocol>
      <host>proxy.example.com</host>
      <port>8080</port>
    </proxy>
  </proxies>
</settings>
```

### 8.2 私有 Maven 仓库

```xml
<settings>
  <mirrors>
    <mirror>
      <id>company-nexus</id>
      <mirrorOf>central</mirrorOf>
      <url>https://nexus.example.com/repository/maven-public/</url>
    </mirror>
    <!-- 阿里云镜像（中国大陆加速） -->
    <mirror>
      <id>aliyun</id>
      <mirrorOf>central</mirrorOf>
      <url>https://maven.aliyun.com/repository/public</url>
    </mirror>
  </mirrors>
  <servers>
    <server>
      <id>company-nexus</id>
      <username>deploy</username>
      <password>password</password>
    </server>
  </servers>
</settings>
```

> **中国大陆用户建议**：使用阿里云 Maven 镜像加速依赖下载。

---

## 9. 构建优化

### 9.1 并行构建

```bash
# 使用 4 个线程并行构建
.\mvnw.cmd clean test -T 4

# 使用每个 CPU 核心 1 个线程
.\mvnw.cmd clean test -T 1C
```

### 9.2 离线构建

```bash
# 先下载所有依赖
.\mvnw.cmd dependency:go-offline

# 离线模式运行（不访问网络）
.\mvnw.cmd test -o
```

### 9.3 增量编译

```bash
# 只运行测试（不 clean，利用之前的编译结果）
.\mvnw.cmd test
```

---

## 10. 构建检查清单

### 10.1 新环境首次构建

- [ ] 安装 JDK 21 并配置 `JAVA_HOME`
- [ ] 验证 `java -version` 输出为 21.x
- [ ] 克隆项目代码
- [ ] 运行 `.\mvnw.cmd clean compile` — 下载依赖并编译
- [ ] 运行 `.\mvnw.cmd clean test` — 执行全量测试
- [ ] 检查 `target/cucumber-reports/cucumber.html` 报告

### 10.2 CI/CD 部署

- [ ] 配置 JDK 21 环境
- [ ] 配置 Maven 缓存（`.m2/repository`）
- [ ] 配置构建触发器（推送 / 定时 / 手动）
- [ ] 配置测试报告解析（JUnit XML / HTML）
- [ ] 配置产物归档（报告 + 日志）
- [ ] 配置失败通知（邮件 / 钉钉 / 企业微信）
- [ ] 验证端到端流程
