# 维护指南

> 版本：1.0.0 | 最后更新：2026-02-28

---

## 1. 概述

本文档指导开发和测试团队如何维护和扩展测试框架，包括添加新协议支持、编写新步骤定义、管理依赖升级和排查常见问题。

---

## 2. 添加新协议支持

框架采用 SPI（Service Provider Interface）机制实现协议插件化。添加新协议只需 **3 步**：

### 2.1 步骤总览

```
1. 实现 ProtocolClient 接口
2. 注册 SPI 服务发现
3. 编写对应的步骤定义
```

### 2.2 详细步骤 — 以 SOAP 为例

#### 第一步：创建协议客户端

在 `src/main/java/com/framework/protocols/soap/` 目录下创建 `SoapClient.java`：

```java
package com.framework.protocols.soap;

import com.framework.core.client.ProtocolClient;
import com.framework.core.client.ProtocolRequest;
import com.framework.core.client.ProtocolResponse;
import com.framework.core.config.ConfigManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class SoapClient implements ProtocolClient {
    private static final Logger log = LoggerFactory.getLogger(SoapClient.class);
    private ConfigManager config;

    @Override
    public String getProtocolName() {
        return "soap";  // 协议标识，必须唯一
    }

    @Override
    public void init(ConfigManager config) {
        this.config = config;
        String wsdlUrl = config.getProperty("soap.wsdl-url", "");
        log.info("Initializing SOAP client with WSDL: {}", wsdlUrl);
        // TODO: 初始化 SOAP 客户端
    }

    @Override
    public ProtocolResponse execute(ProtocolRequest request) {
        long startTime = System.currentTimeMillis();
        log.info("Executing SOAP request: {}", request);

        // TODO: 实现 SOAP 调用逻辑
        // 1. 构建 SOAP Envelope
        // 2. 发送 HTTP(S) 请求
        // 3. 解析 SOAP 响应

        long responseTime = System.currentTimeMillis() - startTime;
        return ProtocolResponse.builder()
                .statusCode(200)
                .body("<soap:Envelope>...</soap:Envelope>")
                .contentType("text/xml")
                .responseTimeMs(responseTime)
                .build();
    }

    @Override
    public void close() {
        log.info("Closing SOAP client");
        // 清理资源
    }
}
```

#### 第二步：注册 SPI

编辑文件 `src/main/resources/META-INF/services/com.framework.core.client.ProtocolClient`，新增一行：

```
com.framework.protocols.rest.RestClient
com.framework.protocols.soap.SoapClient
```

#### 第三步：编写步骤定义

在 `src/test/java/com/framework/stepdefs/soap/` 目录下创建 `SoapStepDefs.java`：

```java
package com.framework.stepdefs.soap;

import com.framework.core.context.TestContext;
import io.cucumber.java.en.Given;
import io.cucumber.java.en.When;
import io.cucumber.java.en.Then;

public class SoapStepDefs {
    private final TestContext context;

    public SoapStepDefs(TestContext context) {
        this.context = context;
    }

    @Given("the SOAP WSDL URL is {string}")
    public void setSoapWsdl(String wsdlUrl) {
        context.getCurrentRequest().extra("soap.wsdl-url", wsdlUrl);
    }

    @When("I send a SOAP request to operation {string}")
    public void sendSoapRequest(String operation) {
        // 设置 SOAP 操作并执行
    }

    @Then("the SOAP response should contain element {string}")
    public void verifySoapElement(String elementName) {
        // 验证 SOAP 响应元素
    }
}
```

#### 第四步：添加依赖（如需要）

在 `pom.xml` 的 `<profiles>` 中添加 SOAP 专属依赖：

```xml
<profile>
    <id>soap</id>
    <dependencies>
        <dependency>
            <groupId>jakarta.xml.ws</groupId>
            <artifactId>jakarta.xml.ws-api</artifactId>
            <version>4.0.0</version>
        </dependency>
    </dependencies>
</profile>
```

#### 第五步：添加配置

在 `application.yml` 中添加 SOAP 配置节：

```yaml
soap:
  wsdl-url: https://example.com/service?wsdl
  connect-timeout: 10000
  read-timeout: 30000
```

### 2.3 协议扩展检查清单

- [ ] 实现 `ProtocolClient` 接口（4 个方法）
- [ ] 在 SPI 文件中注册完整类名
- [ ] 编写对应的 Step Definitions
- [ ] 在 `pom.xml` 添加必要依赖（Profile 隔离）
- [ ] 在 `application.yml` 添加配置
- [ ] 编写 Feature 测试用例验证
- [ ] 更新文档

---

## 3. 添加新步骤定义

### 3.1 步骤定义规范

```java
package com.framework.stepdefs.rest;

import com.framework.core.context.TestContext;
import io.cucumber.java.en.*;

public class NewStepDefs {
    private final TestContext context;

    // 必须通过构造器注入 TestContext（PicoContainer DI）
    public NewStepDefs(TestContext context) {
        this.context = context;
    }

    // Given 步骤 — 设置前置条件
    @Given("some precondition with {string}")
    public void setupPrecondition(String value) {
        // 通过 context 设置请求数据
    }

    // When 步骤 — 执行动作
    @When("I perform some action")
    public void performAction() {
        // 执行操作，结果存入 context
    }

    // Then 步骤 — 验证结果
    @Then("the result should be {string}")
    public void verifyResult(String expected) {
        // 从 context 获取响应并断言
    }
}
```

### 3.2 参数类型

| Cucumber 表达式 | Java 类型   | 示例            |
| --------------- | ----------- | --------------- |
| `{string}`      | `String`    | `"hello"`       |
| `{int}`         | `int`       | `200`           |
| `{long}`        | `long`      | `1234567890`    |
| `{float}`       | `float`     | `3.14`          |
| `{word}`        | `String`    | `GET`（无引号） |
| `{}`（匿名）    | `String`    | 自动推断        |
| `DataTable`     | `DataTable` | 表格数据        |
| `DocString`     | `String`    | `"""..."""` 块  |

### 3.3 注意事项

1. **避免步骤歧义**：不同 Step Definition 的正则表达式不能有重叠匹配
2. **保持原子性**：一个步骤只做一件事
3. **使用 TestContext**：共享数据必须通过 `TestContext`，禁止使用静态变量
4. **日志记录**：关键操作添加 `log.info()` 日志

---

## 4. 依赖管理

### 4.1 当前依赖矩阵

| 依赖         | 版本    | 用途        | 更新频率 |
| ------------ | ------- | ----------- | -------- |
| Cucumber     | 7.20.1  | BDD 框架    | 季度     |
| JUnit 5      | 5.11.4  | 测试引擎    | 季度     |
| REST Assured | 5.5.0   | HTTP 客户端 | 季度     |
| Jackson      | 2.18.2  | JSON 处理   | 月度     |
| JsonPath     | 2.9.0   | JSON 查询   | 低频     |
| AssertJ      | 3.27.3  | 流式断言    | 季度     |
| SLF4J        | 2.0.16  | 日志接口    | 低频     |
| Logback      | 1.5.15  | 日志实现    | 季度     |
| Lombok       | 1.18.36 | 代码简化    | 低频     |
| SnakeYAML    | 2.3     | YAML 解析   | 低频     |

### 4.2 检查依赖更新

```bash
.\mvnw.cmd versions:display-dependency-updates
.\mvnw.cmd versions:display-plugin-updates
```

### 4.3 升级依赖

1. 修改 `pom.xml` 中 `<properties>` 节的版本号
2. 运行编译验证：`.\mvnw.cmd clean compile`
3. 运行全量测试：`.\mvnw.cmd clean test`
4. 检查是否有 API 变更或废弃警告
5. 提交变更并记录升级日志

### 4.4 依赖冲突排查

```bash
# 查看依赖树
.\mvnw.cmd dependency:tree

# 查看特定依赖
.\mvnw.cmd dependency:tree "-Dincludes=com.fasterxml.jackson.core"

# 分析冲突
.\mvnw.cmd enforcer:enforce
```

---

## 5. 添加新测试数据文件

### 5.1 目录结构

```
src/test/resources/
├── features/           # Gherkin 测试用例
│   └── rest/
├── testdata/           # 外部测试数据（JSON/XML）
│   ├── users/
│   │   ├── create_user.json
│   │   └── update_user.json
│   └── orders/
│       └── create_order.json
└── schemas/            # JSON Schema（可选，用于响应校验）
    └── user_schema.json
```

### 5.2 在 Feature 中引用

```gherkin
Given I set the request body from file "testdata/users/create_user.json"
```

---

## 6. 钩子（Hooks）扩展

### 6.1 现有钩子

| 钩子      | 作用                                                | 位置         |
| --------- | --------------------------------------------------- | ------------ |
| `@Before` | 场景开始前 — 初始化 TestContext、记录场景信息       | `Hooks.java` |
| `@After`  | 场景结束后 — 记录结果、失败时附加响应体、清理上下文 | `Hooks.java` |

### 6.2 添加新钩子

```java
// 按照标签执行的钩子
@Before("@auth")
public void setupAuth(Scenario scenario) {
    // 只在 @auth 标签的场景前执行
    // 例如：获取凭证、设置 Token
}

// 指定执行顺序（数字越小越先执行）
@Before(order = 0)
public void globalSetup(Scenario scenario) {
    // 最先执行
}

@Before(order = 10)
public void specificSetup(Scenario scenario) {
    // 后执行
}
```

---

## 7. 故障排查

### 7.1 排查流程

```
问题发现
  ↓
查看 HTML 报告 → 定位失败场景
  ↓
查看日志文件 → target/logs/test-framework.log
  ↓
开启详细日志 → -Dlogging.level.com.framework=DEBUG
  ↓
单独执行失败用例 → -Dcucumber.filter.tags=@failing-tag
  ↓
检查 API 连通性 → curl / Postman 验证
  ↓
检查配置文件 → application.yml / 环境变量
  ↓
检查依赖冲突 → mvnw dependency:tree
```

### 7.2 常见问题

| 问题                                  | 可能原因           | 解决方案                                  |
| ------------------------------------- | ------------------ | ----------------------------------------- |
| `NoSuchMethodError`                   | 依赖版本冲突       | 检查 `dependency:tree`，排除冲突          |
| `ClassNotFoundException`              | SPI 注册遗漏       | 检查 `META-INF/services/` 文件            |
| `NullPointerException` in TestContext | TestContext 未注入 | 确认构造器参数有 `TestContext`            |
| Step Definition 未匹配                | Glue 路径配置错误  | 检查 `junit-platform.properties`          |
| Feature 文件未发现                    | 路径不在 classpath | 确认文件在 `src/test/resources/features/` |
| SSL 证书错误                          | 自签名证书         | 配置 REST Assured 忽略 SSL                |
| 编码问题                              | 非 UTF-8 环境      | 添加 `-Dfile.encoding=UTF-8`              |

### 7.3 开启详细日志

```bash
# 框架组件调试日志
.\mvnw.cmd test "-Dlogging.level.com.framework=DEBUG"

# REST Assured 请求/响应日志
.\mvnw.cmd test "-Drest.log-requests=true" "-Drest.log-responses=true"

# Maven 调试模式
.\mvnw.cmd test -X
```

---

## 8. 代码质量

### 8.1 编码规范

- Java 代码遵循 Google Java Style Guide
- 所有公共方法必须有 JavaDoc 注释
- 步骤定义方法名使用驼峰命名
- Feature 文件使用 UTF-8 编码
- Scenario 名称使用中文或英文描述（保持一致性）

### 8.2 Git 提交规范

```
<type>(<scope>): <subject>

type:
  feat     — 新功能
  fix      — 修复 Bug
  docs     — 文档更新
  refactor — 代码重构
  test     — 测试用例变更
  chore    — 构建/依赖/配置变更

示例：
feat(soap): 添加 SOAP 协议支持
fix(rest): 修复超时配置不生效问题
docs: 更新使用指南
test(rest): 新增用户 CRUD 测试用例
chore(deps): 升级 REST Assured 到 5.5.1
```

### 8.3 分支策略

```
main          ← 稳定版本
├── develop   ← 开发集成
│   ├── feature/soap-support    ← 功能分支
│   ├── feature/kafka-support   ← 功能分支
│   └── bugfix/timeout-issue    ← 修复分支
└── release/1.1.0               ← 发布分支
```

---

## 9. 版本升级检查清单

升级框架时，请按以下步骤操作：

- [ ] 在 `pom.xml` 中更新版本号
- [ ] 运行 `.\mvnw.cmd clean compile` — 确保编译通过
- [ ] 运行 `.\mvnw.cmd clean test` — 确保所有测试通过
- [ ] 查看 HTML 报告确认无异常
- [ ] 检查是否有 Deprecated 警告
- [ ] 更新文档中的版本号
- [ ] 提交代码并创建 Tag
